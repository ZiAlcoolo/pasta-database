<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Détail produit</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- STYLES -->
    <link rel="stylesheet" href="./styles/main-style.css">
    <link rel="stylesheet" href="./styles/detail-produit.css">
</head>

<body>
    <div id="header">
        <div class="header_btn" id="back-btn" onclick="window.location = './catalogue.html'">
            <img src="https://img.icons8.com/fluency-systems-filled/500/back--v1.png">
        </div>
        <div class="header_btn" id="header_logo"><img src="./media/icons/temp-logo.png"></div>
    </div>

    <div id="content">
        <h1>Product Name…</h1>
        <div id="details">
            <p style="padding: 1rem; margin: 0;">Recovering data from cloud...</p>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const sheetID = "1ziYU_8TEzZey5zwPWsEty3Ufimp8VxFp9uRGjw5ou4k";
        const sheetName = "1";
        const apiURL = `https://opensheet.elk.sh/${sheetID}/${encodeURIComponent(sheetName)}`;

        // === PARAMÈTRE URL ===
        function getParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        const desiredProduct = getParam('product');
        $('h1').text(desiredProduct);

        if (!desiredProduct) {
            $('#content').html('<h2>The URL is not containing any product.</h2><p>Example : detail.html?product=Test%20Alpha%20001</p>');
        } else {
            $.getJSON(apiURL).done(function (data) {
                if (!data || data.length === 0) {
                    $('#content').html('<p>Error : No data found</p>');
                    return;
                }

                const target = decodeURIComponent(desiredProduct).toLowerCase();
                let found = data.find(r => (r['Product name'] || '').toLowerCase() === target);
                if (!found) found = data.find(r => (r['Product name'] || '').toLowerCase().includes(target));

                if (!found) {
                    $('#content').html(`<h2>Product not found :</h2><p>Searchnig for : <strong>${desiredProduct}</strong></p>`);
                    return;
                }

                // === CONSTRUCTION DU CONTENU ===
                const $details = $('<table></table>');
                Object.keys(found).forEach(key => {
                    const val = found[key] || '';
                    let displayVal = $('<div>').text(val).html();
                    if (String(val).startsWith('http://') || String(val).startsWith('https://')) {
                        displayVal = `<a href="${val}" target="_blank" rel="noopener">${val}</a>`;
                    }
                    $details.append(`<tr><td class="key">${key}</td><td class="value">${displayVal}</td></tr>`);
                });

                $('#content').html(`
                    <h1>${found['Product name'] || 'Détail produit'}</h1>
                    <div id="details">
                        <div class="card-header">
                            <div class="card-infos">
                                <h2>Product data</h2>
                                <p class="sub-title">Detailed information about the product.</p>
                            </div>
                            <div class="card-actions">
                                <div id="tableSearchBar" class="btn-1">
                                    <button id="toggleSearch"><img src="https://img.icons8.com/fluency-systems-filled/1000/search.png"></button>
                                    <input type="text" id="searchInput" style="display: none;" placeholder="Search...">
                                </div>
                                <button id="copyToClipboard" class="btn-1">
                                    <img src="https://img.icons8.com/fluency-systems-regular/500/copy--v1.png" alt="Copy data">
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                $('#content #details').append($details);
            }).fail(function () {
                $('#content').html('<p>An error occurred while retrieving the data</p>');
            });
        }

        // === RECHERCHE DYNAMIQUE ===
        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function highlightText(element, searchTerm) {
            const text = element.textContent;
            const normalizedText = normalizeText(text);
            const normalizedSearch = normalizeText(searchTerm);

            let resultHTML = "", i = 0;
            while (i < text.length) {
                const subText = normalizedText.substring(i);
                const index = subText.indexOf(normalizedSearch);
                if (index === -1 || !normalizedSearch) {
                    resultHTML += text.substring(i);
                    break;
                }
                resultHTML += text.substring(i, i + index)
                    + `<mark>${text.substring(i + index, i + index + searchTerm.length)}</mark>`;
                i += index + searchTerm.length;
            }
            element.innerHTML = resultHTML;
        }

        $(document).on('click', '#toggleSearch', function () {
            $('#searchInput').animate({ width: 'toggle' }).focus();
        });

        $(document).on('keyup', '#searchInput', function () {
            const searchValue = $(this).val();
            $('#details table tr').each(function () {
                const rowText = normalizeText($(this).text());
                const match = rowText.includes(normalizeText(searchValue));
                $(this).toggle(match);
                $(this).find('mark').contents().unwrap();
                if (match && searchValue.trim() !== '') {
                    $(this).find('td').each(function () {
                        highlightText(this, searchValue);
                    });
                }
            });
        });

        // === COPIE DANS LE PRESSE-PAPIER ===
        $(document).on('click', '#copyToClipboard', function () {
            let data = '';

            // Inclure le titre du produit
            const productTitle = $('h1').text().trim();
            data += `Product name : ${productTitle}\n\n`;

            // Parcours la table
            $('#details table tr').each(function () {
                const rowData = [];
                $(this).find('td').each(function () {
                    rowData.push($(this).text().trim());
                });
                if (rowData.length) data += rowData.join('\t') + '\n';
            });

            navigator.clipboard.writeText(data)
                .then(() => alert('✅ The product data was copied to the clipboard'))
                .catch(err => console.error('Error while copying :', err));
        });
    </script>
</body>

</html>
