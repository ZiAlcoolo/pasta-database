<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Nutritional Catalogue — Overview</title>

    <!-- SEO -->
    <meta name="description"
        content="Prototype directory cataloguing ready-to-use therapeutic foods (RUTF) for severe acute malnutrition. A testing platform to support research, humanitarian action, and policy development.">

    <!-- Open Graph (Facebook, LinkedIn, etc.) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="International Directory of Ready-to-Use Therapeutic Foods">
    <meta property="og:description"
        content="A prototype reference tool cataloguing ready-to-use therapeutic foods (RUTF) used in the prevention and treatment of severe acute malnutrition.">
    <meta property="og:url" content="https://l-salvaterra.netlify.app/catalogue.html">
    <meta property="og:image" content="https://l-salvaterra.netlify.app/media/icons/temp-logo.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="International Directory of Ready-to-Use Therapeutic Foods">
    <meta name="twitter:description"
        content="Prototype directory of ready-to-use therapeutic foods (RUTF) to support researchers, humanitarian actors, and policymakers.">
    <meta name="twitter:image" content="https://l-salvaterra.netlify.app/media/icons/temp-logo.png">

    <!-- Optional -->
    <meta name="robots" content="index, follow">
    <meta name="author" content="Your Organization Name">





    <!-- jQuery + DataTables + Responsive + Buttons -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>

    <!-- STYLES -->
    <link rel="stylesheet" href="./styles/main-style.css">
    <link rel="stylesheet" href="./styles/catalogue.css">
</head>

<body>
    <div id="header">
        <div class="header_btn" id="header_logo">
            <img src="./media/icons/temp-logo.png">
        </div>
    </div>

    <h1>International Directory of Ready-to-Use Therapeutic Foods</h1>
    <p>
        The RUTF Directory is a prototype reference tool currently under development, designed to catalogue ready-to-use
        therapeutic foods (RUTF) used in the prevention and treatment of severe acute malnutrition. At this stage, the
        directory is still in a testing phase, and the products displayed are mock examples used for demonstration
        purposes only. The content is not exhaustive and does not represent real products or manufacturers. The aim is
        to build a platform that will eventually support researchers, humanitarian actors, and policymakers in
        identifying, comparing, and improving RUTF products that save lives around the world.
    </p>

    <div id="CatalogueTable">
        <div class="controls">
            <div class="filters" aria-label="Filters">
                <label>
                    <select id="continentSelect">
                        <option value="">Continent</option>
                    </select>
                </label>

                <label>
                    <select id="countrySelect">
                        <option value="">Country</option>
                    </select>
                </label>

                <label>
                    <select id="typeSelect">
                        <option value="">Production type</option>
                    </select>
                </label>

                <div id="extraFiltersContainer"></div>

                <button class="btn-1" id="resetFilters">
                    <img src="https://img.icons8.com/fluency-systems-filled/1000/clear-filters.png">
                </button>
            </div>

            <div id="tableSearchBar" class="btn-1">
                <button onclick="$('#searchInput').animate({width: 'toggle'});">
                    <img src="https://img.icons8.com/fluency-systems-filled/1000/search.png">
                </button>
                <input type="text" id="searchInput" style="display: none;" placeholder="Search...">
            </div>

            <div id="openExportOverlayMenu">
                <button class="btn-1" onclick="$('#exportOverlayMenu').slideToggle('fast')">Export</button>
                <div id="exportOverlayMenu" style="display: none;">
                    <button class="btn-1" id="exportClipboard">Copy</button>
                    <button class="btn-1" id="exportCSV">CSV</button>
                    <button class="btn-1" id="exportExcel">Excel</button>
                    <button class="btn-1" id="exportPDF">PDF</button>
                </div>
            </div>
        </div>

        <table id="nutritionTable" class="display nowrap"></table>
    </div>

    <script>
        /******************************************************************
         * CONFIG
         ******************************************************************/
        const sheetID = "1ziYU_8TEzZey5zwPWsEty3Ufimp8VxFp9uRGjw5ou4k";
        const sheetName = "1";
        const apiURL = `https://opensheet.elk.sh/${sheetID}/${encodeURIComponent(sheetName)}`;

        const FIELD = {
            name: "Product name",
            type: "Type of production",
            productionLocation: "Production location",
            cost: "Cost",
            link: "Link"
        };

        const ENABLED_FILTERS = {};

        const countryToContinent = {
            "France": "Europe", "Germany": "Europe", "Spain": "Europe", "Italy": "Europe", "Belgium": "Europe",
            "United States": "North America", "Canada": "North America", "Mexico": "North America",
            "China": "Asia", "India": "Asia", "Japan": "Asia",
            "Australia": "Oceania", "New Zealand": "Oceania",
            "Nigeria": "Africa", "South Africa": "Africa", "Morocco": "Africa"
        };

        /******************************************************************
         * MAIN CODE
         ******************************************************************/
        $(function () {
            $.getJSON(apiURL).done(function (data) {
                if (!data || data.length === 0) {
                    $('body').append("<p>No data found.</p>");
                    return;
                }


                /**********************
    * Préparation des filtres
    **********************/
                const countriesSet = new Set();
                const typesSet = new Set();
                const extraSets = {};


                data.forEach(row => {
                    const rawLoc = row[FIELD.productionLocation] || "";
                    let country = rawLoc.includes(",") ? rawLoc.split(",").pop().trim() : rawLoc.trim();
                    if (country) countriesSet.add(country);
                    if (row[FIELD.type]) typesSet.add(row[FIELD.type]);
                    Object.values(ENABLED_FILTERS).forEach(col => {
                        if (!extraSets[col]) extraSets[col] = new Set();
                        if (row[col]) extraSets[col].add(row[col]);
                    });
                });

                const continentToCountries = {};
                countriesSet.forEach(c => {
                    const cont = countryToContinent[c] || "Other / Unknown";
                    if (!continentToCountries[cont]) continentToCountries[cont] = new Set();
                    continentToCountries[cont].add(c);
                });

                const $continent = $('#continentSelect');
                Object.keys(continentToCountries).sort().forEach(c => $continent.append(`<option value="${c}">${c}</option>`));

                const $country = $('#countrySelect');
                Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));

                const $type = $('#typeSelect');
                Array.from(typesSet).sort().forEach(t => $type.append(`<option value="${t}">${t}</option>`));

                const $extra = $('#extraFiltersContainer');
                Object.entries(ENABLED_FILTERS).forEach(([label, col]) => {
                    const setValues = Array.from(extraSets[col] || []);
                    if (setValues.length === 0) return;
                    const id = 'filter_' + col.replace(/\s+/g, '_');
                    const $sel = $(`<label>${label} <select id="${id}"><option value="">All</option></select></label>`);
                    setValues.forEach(v => $sel.find('select').append(`<option value="${v}">${v}</option>`));
                    $extra.append($sel);
                });



                /**********************
                     * Préparation des colonnes
                     **********************/
                const allKeys = Object.keys(data[0]);
                const visibleKeys = [
                    FIELD.name,
                    FIELD.type,
                    FIELD.productionLocation,
                    FIELD.cost,
                    FIELD.link
                ];
                const hiddenKeys = allKeys.filter(k => !visibleKeys.includes(k));

                const columns = allKeys.map(key => {
                    if (key === FIELD.link) {
                        return {
                            title: "",
                            data: key,
                            render: function (data) {
                                return `<img height="20" src="https://img.icons8.com/material-rounded/500/visible.png">`;
                            },
                            orderable: false,
                            searchable: false
                        };
                    }
                    return { title: key, data: key };
                });



                /**********************
    * Initialisation du tableau
    **********************/
                const table = $('#nutritionTable').DataTable({
                    data,
                    columns,
                    pageLength: 20,
                    responsive: false,
                    dom: 'Bfrtip',
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/en-GB.json' },
                    columnDefs: [
                        { targets: hiddenKeys.map(k => allKeys.indexOf(k)), visible: false, searchable: true }
                    ],
                    buttons: [
                        {
                            extend: 'copyHtml5',
                            text: 'Copy',
                            className: 'btn-1',
                            exportOptions: {
                                columns: function (idx, data, node) { return true; }, // exporte toutes les colonnes
                                rows: ':visible' // mais uniquement les lignes visibles après filtrage
                            }
                        },
                        {
                            extend: 'csvHtml5',
                            text: 'CSV',
                            className: 'btn-1',
                            exportOptions: {
                                columns: function (idx, data, node) { return true; },
                                rows: ':visible'
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Excel',
                            className: 'btn-1',
                            exportOptions: {
                                columns: function (idx, data, node) { return true; },
                                rows: ':visible'
                            }
                        },
                        {
                            extend: 'pdfHtml5',
                            text: 'PDF',
                            className: 'btn-1',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            exportOptions: {
                                columns: function (idx, data, node) { return true; },
                                rows: ':visible'
                            },
                            customize: function (doc) {
                                doc.styles.tableHeader.alignment = 'left';
                                doc.defaultStyle.fontSize = 9;
                                doc.pageMargins = [40, 40, 40, 40];
                            }
                        }
                    ]

                });

                /**********************
                 * Boutons d’export
                 **********************/
                $('#exportClipboard').on('click', () => table.button('.buttons-copy').trigger());
                $('#exportCSV').on('click', () => table.button('.buttons-csv').trigger());
                $('#exportExcel').on('click', () => table.button('.buttons-excel').trigger());
                $('#exportPDF').on('click', () => table.button('.buttons-pdf').trigger());




                /**********************
    * Recherche globale accent-insensitive
    **********************/
                function normalizeText(text) {
                    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                }
                $.fn.dataTable.ext.type.search.string = function (data) {
                    return !data ? '' : typeof data === 'string' ? normalizeText(data) : data;
                };



                // Animation ouverture/fermeture du champ
                $('#toggleSearch').on('click', function (e) {
                    e.stopPropagation();
                    $('#searchInput').animate({ width: 'toggle' }, 150).focus();
                });

                // Ferme le champ si clic en dehors
                $(document).on('click', function (e) {
                    if (!$(e.target).closest('#tableSearchBar').length && $('#searchInput').val() == "") {
                        $('#searchInput').hide();
                    }
                    if (!$(e.target).closest('#openExportOverlayMenu').length) {
                        $('#exportOverlayMenu').hide();
                    }
                });

                // Recherche personnalisée dans la DataTable
                $(document).on('keyup', '#searchInput', function () {
                    const value = $(this).val().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                    $('#nutritionTable').DataTable().search(value).draw();
                });




                $.fn.dataTable.ext.search.push(function (_, __, dataIndex) {
                    const row = table.row(dataIndex).data();
                    if (!row) return true;

                    const continent = $('#continentSelect').val();
                    const country = $('#countrySelect').val();
                    const type = $('#typeSelect').val();

                    if (country && !(row[FIELD.productionLocation] || "").toLowerCase().includes(country.toLowerCase()))
                        return false;

                    if (!country && continent) {
                        let ctry = (row[FIELD.productionLocation] || "").split(",").pop().trim();
                        const cont = countryToContinent[ctry] || "Other / Unknown";
                        if (cont !== continent) return false;
                    }

                    if (type && (row[FIELD.type] || "").toLowerCase() !== type.toLowerCase())
                        return false;

                    return true;
                });

                $('#continentSelect').on('change', function () {
                    const cont = $(this).val();
                    $country.find('option').remove().append('<option value="">All</option>');
                    if (!cont)
                        Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    else
                        Array.from(continentToCountries[cont] || []).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    table.draw();
                });

                $('#countrySelect, #typeSelect, #extraFiltersContainer select').on('change', () => table.draw());

                function adjustSelectWidth(select) {
                    const tmp = document.createElement("span");
                    tmp.style.visibility = "hidden";
                    tmp.style.whiteSpace = "nowrap";
                    tmp.style.font = window.getComputedStyle(select).font;
                    tmp.textContent = select.options[select.selectedIndex].text;
                    document.body.appendChild(tmp);
                    select.style.width = tmp.offsetWidth + 55 + "px";
                    tmp.remove();
                }

                document.querySelectorAll('.filters select').forEach(select => {
                    adjustSelectWidth(select);
                    select.addEventListener('change', () => {
                        adjustSelectWidth(select);

                        const wrapper = select.closest('label');
                        if (select.value !== "") {
                            wrapper.classList.add('active');
                        } else {
                            wrapper.classList.remove('active');
                        }

                    });
                });

                $('#resetFilters').on('click', () => {
                    $('#continentSelect, #countrySelect, #typeSelect').val('');
                    $('#extraFiltersContainer select').val('');
                    table.search('').draw();
                    $('#searchInput').val('');
                    document.querySelectorAll('.filters select').forEach(select => {
                        adjustSelectWidth(select);
                        const wrapper = select.closest('label');
                        wrapper.classList.remove('active');
                    }

                    );
                });

                $('#nutritionTable tbody').on('click', 'td:last-child', function () {
                    const tr = $(this).closest('tr');
                    const row = table.row(tr).data();

                    if (row && row[FIELD.name]) {
                        const productName = encodeURIComponent(row[FIELD.name]);
                        window.location.href = `detail.html?product=${productName}`;
                    }
                });
            });
        });
    </script>
</body>

</html>