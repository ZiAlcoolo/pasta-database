<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Catalogue nutritionnel ‚Äî Aper√ßu</title>

    <!-- jQuery + DataTables + Responsive + Buttons -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>


    <!-- STYLES -->
    <link rel="stylesheet" href="./styles/main-style.css">
    <link rel="stylesheet" href="./styles/catalogue.css">

</head>

<body>
    <div id="header">

        <div class="header_btn" id="header_logo"><img src="./media/icons/temp-logo.png"></div>
    </div>

    <h1>Catalogue nutritionnel</h1>
    <p>D√©couvrez tous les types de p√¢tes propos√©es autour du monde et trouvez celles qui correspondent le mieux √† vos
        besoins et attentes parmis une large s√©lection de choix couramment mise √† jour.</p>

    <div id="CatalogueTable">
        <div class="controls">
            <div class="filters" aria-label="Filtres">
                <label>
                    <select id="continentSelect">
                        <option value="">Contient</option>
                    </select>
                </label>

                <label>
                    <select id="countrySelect">
                        <option value="">Pays</option>
                    </select>
                </label>

                <label>
                    <select id="typeSelect">
                        <option value="">Type production</option>
                    </select>
                </label>

                <div id="extraFiltersContainer"></div>
                <button class="btn-1" id="resetFilters"><img
                        src="https://img.icons8.com/fluency-systems-filled/1000/clear-filters.png"></button>
            </div>
            <div id="tableSearchBar" class="btn-1">
                <button onclick="$('#searchInput').animate({width: 'toggle'});"><img
                        src="https://img.icons8.com/fluency-systems-filled/1000/search.png"></button>
                <input type="text" id="searchInput" style="display: none;" placeholder="Rechercher...">
            </div>

            <div id="openExportOverlayMenu">
                <button class="btn-1" onclick="$('#exportOverlayMenu').slideToggle('fast')">Export</button>
                <div id="exportOverlayMenu" style="display: none;">
                    <button class="btn-1" id="exportClipboard">Copier</button>
                    <button class="btn-1" id="exportCSV">CSV</button>
                    <button class="btn-1" id="exportExcel">Excel</button>
                    <button class="btn-1" id="exportPDF">PDF</button>
                </div>
            </div>
        </div>

        <table id="nutritionTable" class="display nowrap"></table>
    </div>






    <script>
        /******************************************************************
   * CONFIG
   ******************************************************************/
        const sheetID = "1ziYU_8TEzZey5zwPWsEty3Ufimp8VxFp9uRGjw5ou4k";
        const sheetName = "1";
        const apiURL = `https://opensheet.elk.sh/${sheetID}/${encodeURIComponent(sheetName)}`;

        const FIELD = {
            name: "Nom du Produit",
            type: "Type of production",
            productionLocation: "Production location",
            cost: "Cost",
            link: "Link"
        };

        const ENABLED_FILTERS = {
            // "Shelf Life": "Shelf Life",
            // "Acceptability": "Acceptability"
        };

        const countryToContinent = {
            "France": "Europe", "Germany": "Europe", "Spain": "Europe", "Italy": "Europe", "Belgium": "Europe",
            "United States": "North America", "Canada": "North America", "Mexico": "North America",
            "China": "Asia", "India": "Asia", "Japan": "Asia",
            "Australia": "Oceania", "New Zealand": "Oceania",
            "Nigeria": "Africa", "South Africa": "Africa", "Morocco": "Africa"
        };

        /******************************************************************
         * CODE PRINCIPAL
         ******************************************************************/
        $(function () {
            $.getJSON(apiURL).done(function (data) {
                if (!data || data.length === 0) {
                    $('body').append("<p>Aucune donn√©e trouv√©e.</p>");
                    return;
                }

                const countriesSet = new Set();
                const typesSet = new Set();
                const extraSets = {};

                data.forEach(row => {
                    const rawLoc = row[FIELD.productionLocation] || "";
                    let country = rawLoc.includes(",") ? rawLoc.split(",").pop().trim() : rawLoc.trim();
                    if (country) countriesSet.add(country);

                    if (row[FIELD.type]) typesSet.add(row[FIELD.type]);

                    Object.values(ENABLED_FILTERS).forEach(col => {
                        if (!extraSets[col]) extraSets[col] = new Set();
                        if (row[col]) extraSets[col].add(row[col]);
                    });
                });

                // continent ‚Üí countries mapping
                const continentToCountries = {};
                countriesSet.forEach(c => {
                    const cont = countryToContinent[c] || "Autre / Inconnu";
                    if (!continentToCountries[cont]) continentToCountries[cont] = new Set();
                    continentToCountries[cont].add(c);
                });

                // populate filters
                const $continent = $('#continentSelect');
                Object.keys(continentToCountries).sort().forEach(c => $continent.append(`<option value="${c}">${c}</option>`));

                const $country = $('#countrySelect');
                Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));

                const $type = $('#typeSelect');
                Array.from(typesSet).sort().forEach(t => $type.append(`<option value="${t}">${t}</option>`));

                // extra filters
                const $extra = $('#extraFiltersContainer');
                Object.entries(ENABLED_FILTERS).forEach(([label, col]) => {
                    const setValues = Array.from(extraSets[col] || []);
                    if (setValues.length === 0) return;
                    const id = 'filter_' + col.replace(/\s+/g, '_');
                    const $sel = $(`<label>${label} <select id="${id}"><option value="">Tous</option></select></label>`);
                    setValues.forEach(v => $sel.find('select').append(`<option value="${v}">${v}</option>`));
                    $extra.append($sel);
                });

                // columns for table
                const columns = [
                    { title: FIELD.name, data: FIELD.name },
                    { title: FIELD.type, data: FIELD.type },
                    { title: FIELD.productionLocation, data: FIELD.productionLocation },
                    { title: FIELD.cost, data: FIELD.cost },
                    {
                        title: "",
                        data: FIELD.link,
                        render: function (data, type, row) {
                            if (!data) return '<span style="color:#888;">‚Äî</span>';
                            return `<img height="20" src="https://img.icons8.com/fluency-systems-filled/50/long-arrow-right.png">`;
                        },
                        orderable: false,
                        searchable: false
                    }
                ];

                /**************************************************************
         * üß© Initialisation DataTable avec export
         **************************************************************/
                const table = $('#nutritionTable').DataTable({
                    data,
                    columns,
                    pageLength: 20,
                    responsive: false,
                    dom: 'Brt', // B = boutons export, r = processing, t = table
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json' },
                    buttons: [
                        {
                            extend: 'copyHtml5',
                            text: 'Copier',
                            className: 'btn-1',
                            exportOptions: { columns: ':visible:not(:last-child)' } // exclut "Lien"
                        },
                        {
                            extend: 'csvHtml5',
                            text: 'CSV',
                            className: 'btn-1',
                            exportOptions: { columns: ':visible:not(:last-child)' }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Excel',
                            className: 'btn-1',
                            exportOptions: { columns: ':visible:not(:last-child)' }
                        },
                        {
                            extend: 'pdfHtml5',
                            text: 'PDF',
                            className: 'btn-1',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            exportOptions: { columns: ':visible:not(:last-child)' },
                            customize: function (doc) {
                                doc.styles.tableHeader.alignment = 'left';
                                doc.defaultStyle.fontSize = 9;
                                doc.pageMargins = [40, 40, 40, 40];
                            }
                        }
                    ]
                });


                /**************************************************************
                * üßæ Liaison boutons export personnalis√©s
                **************************************************************/
                $('#exportClipboard').on('click', () => table.button('.buttons-copy').trigger());
                $('#exportCSV').on('click', () => table.button('.buttons-csv').trigger());
                $('#exportExcel').on('click', () => table.button('.buttons-excel').trigger());
                $('#exportPDF').on('click', () => table.button('.buttons-pdf').trigger());


                // Fonction pour normaliser le texte (supprime les accents et met en minuscule)
                function normalizeText(text) {
                    return text
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .toLowerCase();
                }

                // Surcharge la fonction de recherche de DataTables pour la rendre accent-insensible
                $.fn.dataTable.ext.type.search.string = function (data) {
                    return !data
                        ? ''
                        : typeof data === 'string'
                            ? normalizeText(data)
                            : data;
                };

                // Recherche manuelle globale (accent-insensible)
                $('#tableSearchBar').on('keyup', '#searchInput', function () {
                    const value = normalizeText($(this).val());
                    table.search(value).draw();
                });



                // filtres continent / pays / type / extra
                $.fn.dataTable.ext.search.push(function (settings, _, dataIndex) {
                    const row = table.row(dataIndex).data();
                    if (!row) return true;

                    const continent = $('#continentSelect').val();
                    const country = $('#countrySelect').val();
                    const type = $('#typeSelect').val();

                    // country filter
                    if (country && !(row[FIELD.productionLocation] || "").toLowerCase().includes(country.toLowerCase()))
                        return false;

                    // continent filter
                    if (!country && continent) {
                        let ctry = (row[FIELD.productionLocation] || "").split(",").pop().trim();
                        const cont = countryToContinent[ctry] || "Autre / Inconnu";
                        if (cont !== continent) return false;
                    }

                    // type
                    if (type && (row[FIELD.type] || "").toLowerCase() !== type.toLowerCase())
                        return false;

                    // extra
                    for (const [_, col] of Object.entries(ENABLED_FILTERS)) {
                        const val = $('#filter_' + col.replace(/\s+/g, '_')).val();
                        if (val && !(row[col] || "").toLowerCase().includes(val.toLowerCase()))
                            return false;
                    }

                    return true;
                });

                // √©v√©nements
                $('#continentSelect').on('change', function () {
                    const cont = $(this).val();
                    $country.find('option').remove().append('<option value="">Tous</option>');
                    if (!cont)
                        Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    else
                        Array.from(continentToCountries[cont] || []).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    table.draw();
                });

                $('#countrySelect, #typeSelect, #extraFiltersContainer select').on('change', () => table.draw());

                // Fonction qui ajuste la largeur du select selon l'option choisie
                function adjustSelectWidth(select) {
                    const tmp = document.createElement("span");
                    tmp.style.visibility = "hidden";
                    tmp.style.whiteSpace = "nowrap";
                    tmp.style.font = window.getComputedStyle(select).font;
                    tmp.textContent = select.options[select.selectedIndex].text;
                    document.body.appendChild(tmp);
                    select.style.width = tmp.offsetWidth + 55 + "px"; // marge pour la fl√®che
                    tmp.remove();
                }

                // Ajustement initial + au changement de valeur
                document.querySelectorAll('.filters select').forEach(select => {
                    adjustSelectWidth(select);
                    select.addEventListener('change', () => adjustSelectWidth(select));
                });


                $('#resetFilters').on('click', () => {
                    $('#continentSelect, #countrySelect, #typeSelect').val('');
                    $('#extraFiltersContainer select').val('');
                    table.search('').draw();
                    $('#searchInput').val('');
                    document.querySelectorAll('.filters select').forEach(select => {
                        adjustSelectWidth(select);
                    });
                });

                // clic sur une ic√¥ne de lien ‚Üí page d√©tail
                $('#nutritionTable tbody').on('click', 'td:last-child', function () {
                    const tr = $(this).closest('tr');
                    const row = table.row(tr).data();

                    if (row && row[FIELD.name]) {
                        const productName = encodeURIComponent(row[FIELD.name]);
                        window.location.href = `detail.html?product=${productName}`;
                    }
                });

            });
        });

    </script>
</body>

</html>