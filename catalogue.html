<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Catalogue nutritionnel — Aperçu</title>

    <!-- jQuery + DataTables + Responsive + Buttons -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>


    <!-- STYLES -->
    <link rel="stylesheet" href="./styles/catalogue.css">

</head>

<body>
    <div id="header_logo"><img src="./media/icons/temp-logo.png"></div>
    
    <h1>Catalogue nutritionnel</h1>
    <p>Découvrez tous les types de pâtes proposées autour du monde et trouvez celles qui correspondent le mieux à vos
        besoins et attentes parmis une large sélection de choix couramment mise à jour.</p>

    <div id="CatalogueTable">
        <div class="controls">
            <div class="filters" aria-label="Filtres">
                <label>
                    <select id="continentSelect">
                        <option value="">Contient</option>
                    </select>
                </label>

                <label>
                    <select id="countrySelect">
                        <option value="">Pays</option>
                    </select>
                </label>

                <label>
                    <select id="typeSelect">
                        <option value="">Type production</option>
                    </select>
                </label>

                <div id="extraFiltersContainer"></div>
                <button class="btn-1" id="resetFilters"><img
                        src="https://img.icons8.com/fluency-systems-filled/1000/clear-filters.png"></button>
            </div>
            <div id="tableSearchBar" class="btn-1">
                <button onclick="$('#searchInput').animate({width: 'toggle'});"><img src="https://img.icons8.com/fluency-systems-filled/1000/search.png"></button>
                <input type="text" id="searchInput" style="display: none;" placeholder="Rechercher dans tout le catalogue...">
            </div>

            <div id="openExportOverlayMenu">
                <button class="btn-1" onclick="$('#exportOverlayMenu').slideToggle('fast')">Export</button>
                <div id="exportOverlayMenu" style="display: none;">
                    <button class="btn-1" id="exportCSV">CSV</button>
                    <button class="btn-1" id="exportExcel">Excel</button>
                    <button class="btn-1" id="exportPrint">Impression</button>
                </div>
            </div>
        </div>

        <table id="nutritionTable" class="display nowrap" style="width:100%"></table>
    </div>






    <script>
        /******************************************************************
   * CONFIG
   ******************************************************************/
        const sheetID = "1ziYU_8TEzZey5zwPWsEty3Ufimp8VxFp9uRGjw5ou4k";
        const sheetName = "1";
        const apiURL = `https://opensheet.elk.sh/${sheetID}/${encodeURIComponent(sheetName)}`;

        const FIELD = {
            name: "Nom du Produit",
            type: "Type of production",
            productionLocation: "Production location",
            cost: "Cost",
            link: "Link"
        };

        const ENABLED_FILTERS = {
            // "Shelf Life": "Shelf Life",
            // "Acceptability": "Acceptability"
        };

        const countryToContinent = {
            "France": "Europe", "Germany": "Europe", "Spain": "Europe", "Italy": "Europe", "Belgium": "Europe",
            "United States": "North America", "Canada": "North America", "Mexico": "North America",
            "China": "Asia", "India": "Asia", "Japan": "Asia",
            "Australia": "Oceania", "New Zealand": "Oceania",
            "Nigeria": "Africa", "South Africa": "Africa", "Morocco": "Africa"
        };

        /******************************************************************
         * CODE PRINCIPAL
         ******************************************************************/
        $(function () {
            $.getJSON(apiURL).done(function (data) {
                if (!data || data.length === 0) {
                    $('body').append("<p>Aucune donnée trouvée.</p>");
                    return;
                }

                const countriesSet = new Set();
                const typesSet = new Set();
                const extraSets = {};

                data.forEach(row => {
                    const rawLoc = row[FIELD.productionLocation] || "";
                    let country = rawLoc.includes(",") ? rawLoc.split(",").pop().trim() : rawLoc.trim();
                    if (country) countriesSet.add(country);

                    if (row[FIELD.type]) typesSet.add(row[FIELD.type]);

                    Object.values(ENABLED_FILTERS).forEach(col => {
                        if (!extraSets[col]) extraSets[col] = new Set();
                        if (row[col]) extraSets[col].add(row[col]);
                    });
                });

                // continent → countries mapping
                const continentToCountries = {};
                countriesSet.forEach(c => {
                    const cont = countryToContinent[c] || "Autre / Inconnu";
                    if (!continentToCountries[cont]) continentToCountries[cont] = new Set();
                    continentToCountries[cont].add(c);
                });

                // populate filters
                const $continent = $('#continentSelect');
                Object.keys(continentToCountries).sort().forEach(c => $continent.append(`<option value="${c}">${c}</option>`));

                const $country = $('#countrySelect');
                Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));

                const $type = $('#typeSelect');
                Array.from(typesSet).sort().forEach(t => $type.append(`<option value="${t}">${t}</option>`));

                // extra filters
                const $extra = $('#extraFiltersContainer');
                Object.entries(ENABLED_FILTERS).forEach(([label, col]) => {
                    const setValues = Array.from(extraSets[col] || []);
                    if (setValues.length === 0) return;
                    const id = 'filter_' + col.replace(/\s+/g, '_');
                    const $sel = $(`<label>${label} <select id="${id}"><option value="">Tous</option></select></label>`);
                    setValues.forEach(v => $sel.find('select').append(`<option value="${v}">${v}</option>`));
                    $extra.append($sel);
                });

                // columns for table
                const columns = [
                    { title: FIELD.name, data: FIELD.name },
                    { title: FIELD.type, data: FIELD.type },
                    { title: FIELD.productionLocation, data: FIELD.productionLocation },
                    { title: FIELD.cost, data: FIELD.cost }
                ];

                // init DataTable
                const table = $('#nutritionTable').DataTable({
                    data,
                    columns,
                    pageLength: 20,
                    responsive: true,
                    dom: 't', // no auto search bar
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json' }
                });


                // recherche manuelle globale
                $('#tableSearchBar').on('keyup', '#searchInput', function () {
                    const value = $(this).val();
                    table.search(value).draw();
                });


                // filtres continent / pays / type / extra
                $.fn.dataTable.ext.search.push(function (settings, _, dataIndex) {
                    const row = table.row(dataIndex).data();
                    if (!row) return true;

                    const continent = $('#continentSelect').val();
                    const country = $('#countrySelect').val();
                    const type = $('#typeSelect').val();

                    // country filter
                    if (country && !(row[FIELD.productionLocation] || "").toLowerCase().includes(country.toLowerCase()))
                        return false;

                    // continent filter
                    if (!country && continent) {
                        let ctry = (row[FIELD.productionLocation] || "").split(",").pop().trim();
                        const cont = countryToContinent[ctry] || "Autre / Inconnu";
                        if (cont !== continent) return false;
                    }

                    // type
                    if (type && (row[FIELD.type] || "").toLowerCase() !== type.toLowerCase())
                        return false;

                    // extra
                    for (const [_, col] of Object.entries(ENABLED_FILTERS)) {
                        const val = $('#filter_' + col.replace(/\s+/g, '_')).val();
                        if (val && !(row[col] || "").toLowerCase().includes(val.toLowerCase()))
                            return false;
                    }

                    return true;
                });

                // événements
                $('#continentSelect').on('change', function () {
                    const cont = $(this).val();
                    $country.find('option').remove().append('<option value="">Tous</option>');
                    if (!cont)
                        Array.from(countriesSet).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    else
                        Array.from(continentToCountries[cont] || []).sort().forEach(c => $country.append(`<option value="${c}">${c}</option>`));
                    table.draw();
                });

                $('#countrySelect, #typeSelect, #extraFiltersContainer select').on('change', () => table.draw());

                // Fonction qui ajuste la largeur du select selon l'option choisie
                function adjustSelectWidth(select) {
                    const tmp = document.createElement("span");
                    tmp.style.visibility = "hidden";
                    tmp.style.whiteSpace = "nowrap";
                    tmp.style.font = window.getComputedStyle(select).font;
                    tmp.textContent = select.options[select.selectedIndex].text;
                    document.body.appendChild(tmp);
                    select.style.width = tmp.offsetWidth + 55 + "px"; // marge pour la flèche
                    tmp.remove();
                }

                // Ajustement initial + au changement de valeur
                document.querySelectorAll('.filters select').forEach(select => {
                    adjustSelectWidth(select);
                    select.addEventListener('change', () => adjustSelectWidth(select));
                });


                $('#resetFilters').on('click', () => {
                    $('#continentSelect, #countrySelect, #typeSelect').val('');
                    $('#extraFiltersContainer select').val('');
                    table.search('').draw();
                    $('#searchInput').val('');
                    document.querySelectorAll('.filters select').forEach(select => {
                        adjustSelectWidth(select);
                    });
                });

                // clic sur une ligne → page détail
                $('#nutritionTable tbody').on('click', 'tr', function () {
                    const row = table.row(this).data();
                    if (row && row[FIELD.name]) {
                        window.location.href = `detail.html?product=${encodeURIComponent(row[FIELD.name])}`;
                    }
                });
            });
        });

    </script>
</body>

</html>